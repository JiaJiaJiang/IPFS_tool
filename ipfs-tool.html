<meta charset="utf-8">
<title>IPFS tool</title>
<style>
	.funcBlock{
		border:2px solid #000;
		margin: 1em;
		padding: 1em;
	}
	.testResultBlock{
	    border: 1px solid #ccc;
	    border-radius: 3px;
	    display: block;
	    cursor: pointer;
	    position: relative;
	}
	.testResultBlock span{
	    margin-left: 1em; 
	}
	.testResultBlock:hover{
		background-color: #cccccc99;
	}
	.testResultBlock #accessible{
		display: inline;
		margin: 0 auto;
		width:1em;
		height: 1em;
	}
	.testResultBlock #accessible::after{
		position: absolute;
		content: '...';
		top:0;
		left:0;
		width: 100%;
		height: 100%;
	}
	.limitWidth{max-width: 100%;}
	.red{color:red;}
	.green{color:green;}
	#sourceURL::before{
		content: 	'link: ';
	}
	#sourceContentType::before{
		content: 	'Type: ';
	}
</style>
<div class="funcBlock">
	<h2>Gateway</h2>
	<b>Current gateway:</b><input id="currentGatewayInput" style="width:20em"></input><br>
	<div style="display:flex;margin-top: 1em;">
		<div style="flex-grow: 0;margin-right: 1em;">
			<textarea cols="30" rows="30" id="gatewayListArea" style="display: block;"></textarea>
			<button id="testButton">Test</button> <label><input type="checkbox" id="disanleAutoTest"><span>disable auto test</span></label>
		</div>
		<div id="testResultArea" style="flex-grow: 1;display: inline-block;" title="click to select current gateway"></div>
	</div>
</div>
<div class="funcBlock">
	<h2>source view</h2>
	<div style="display: flex;">
		source path : &nbsp;<input type="text" id="sourcePathInput" placeholder="/ipfs/... | Qm... | address" style="flex-grow: 1;"> <button id="viewButton">view</button>
	</div>
	<a id="sourceURL" style="color:#blue;margin: .6em;display: block;word-break: break-all;"  target="_blank"></a>
	<div id="sourceContentType" style="color:#ccc;margin: .6em;"></div>
	<div id="viewArea"></div>
</div>
<script>
//default gateways
var defaultGatewayList=[
	"https://ipfs.io/",
	"https://gateway.ipfs.io/",
	"https://ipfs.infura.io/",
	"https://xmine128.tk/",
	"https://ipfs.jes.xxx/",
	"https://siderus.io/",
	"https://ipfs.eternum.io/",
	"https://hardbin.com/",
	"https://ipfs.wa.hle.rs/",
	"https://ipfs.renehsz.com/",
	"https://cloudflare-ipfs.com/",
	"https://gateway.swedneck.xyz/",
	"https://rx14.co.uk/",
	"https://ipfs.wa.hle.rs/",
	"https://ipfs.macholibre.org/",
	"https://catalunya.network/",
	"https://ipfs.works/",
	"https://upload.global/",
	"https://api.wisdom.sh/",
	"https://ipfs.work/",
	"https://ipfs.netw0rk.io/",
	"https://gateway.blocksec.com/"
];

class storage{
	static get(name,defaultValue){
		return localStorage.getItem(name)||defaultValue;
	}
	static set(name,value){
		return localStorage.setItem(name,value);
	}
}
function element(tag){return document.createElement(tag)}
function rmEmptyDup(arr){
	return  [...new Set(arr)].filter(e=>e&&e.trim());
}
function removeEtxSlash(str){
	//remove extra slashes in the path
	return str.replace(/\/{2,}/g,'/');
}
function toIPFSPath(addr){
	addr=removeEtxSlash(addr.trim());
	var r;
	if(r=addr.match(/Qm[A-z\d]{44}.*$/)){
		return removeEtxSlash(`/ipfs/${r[0]}`);
	}
	throw(new Error('Cannoy parse IPFS path'));
}

function getSavedList(){
	try{
		return rmEmptyDup(storage.get('gatewayList','').split('\n'));
	}catch(e){
		console.error(e);
		return [];
	}
}
function saveList(arr){
	//save to storage
	return storage.set('gatewayList',rmEmptyDup(arr).join('\n'));
}
function enabledGateway(g){
	if(g){
		g=g.trim();
		currentGatewayInput.value=g;
		storage.set('enabledGateway',g);
	}else{
		return storage.get('enabledGateway','').trim()||'https://ipfs.io';
	}
}
function autoTestDisabled(tog){//1 || ''
	if(tog != undefined){
		storage.set('disableAutoTest',tog?1:'');
	}else{
		return !!storage.get('disableAutoTest',false);
	}
}
function testGateway(gateway,path=toIPFSPath('QmVnS9etu7B3wN9S7DwRCtM37pwx6XJ3b48ag9A8H1akAc')){
	var headers = new Headers();
	headers.append('range','bytes=0-');
	return fetch(removeEtxSlash(`${gateway}${toIPFSPath(path)}`),{
		method:'HEAD',
		referrerPolicy:'origin-when-cross-origin',
		redirect:'follow',
		mode:'cors',
		//headers,
	}).then(res=>{
			/*console.group();
			console.log(gateway);
			console.log(res.status);
			console.log('ok?',res.ok);
			console.log('location',res.headers.get('location'));
			console.groupEnd();*/
			return res;
	});
}

function previewMode(mode,url,res){
	viewArea.innerHTML='';
	switch(mode){
		case 'video':{
			var V=element('video');
			V.src=url;
			V.controls=true;
			V.className='limitWidth';
			viewArea.appendChild(V);
			break;
		}
		case 'image':{
			var I=element('img');
			I.src=url;
			viewArea.appendChild(I);
			break;
		}
		case 'text':{
			var T=element('div');
			T.style='width:100%;min-height:50%;max-height:100%;overflow: auto;border: 1px solid #ccc;';
			T.setAttribute('contenteditable','true');
			res.text().then(t=>T.innerText=t);
			viewArea.appendChild(T);
			break;
		}
		case 'iframe':{
			var I=element('iframe');
			I.src=url;
			I.style='width:100%;height:90%;'
			viewArea.appendChild(I);
			break;
		}
		default:{
			var E=element('a');
			E.innerHTML='Unable to view it, please download or open in a new tab.'
			E.href=url;
			viewArea.appendChild(E);
		}
	}
}
function setPageArg(name,value){
	if(value == undefined){
		delete pageArgs[name];
		return;
	}
	pageArgs[name]=encodeURIComponent(value);
	var l=[];
	for(a in pageArgs){
		l.push(`${a}=${pageArgs[a]}`);
	}
	location.hash=l.join('&');
}
class ResultBlock{
	constructor(gateway){
		this.path=removeEtxSlash(`${gateway}${toIPFSPath('Qmf5grXACgqhvYSPnEmLRMjtxSCStpe3WLPY4n9uX8pUX5/yes.png')}`).trim();
		this.block=element('div');
		this.block.className='testResultBlock';
		this.block.onclick=e=>enabledGateway(gateway);
		this.block.innerHTML=`<img id='accessible' src="${this.path}"><span id='gateway'>${gateway}</span>`;
	}
	addText(text){
		var d=element('span');
		d.innerHTML=text;
		this.block.appendChild(d);
	}
}



//init
var pageArgs={};
rmEmptyDup(location.hash.replace(/^\#/,'').split('&')).map(a=>{
	var p=a.split('=');
	if(p.length){
		pageArgs[p.shift()]=p.join('=');
	}
});
disanleAutoTest.checked=autoTestDisabled();

//set default gateway
if(getSavedList().length===0){
	saveList(defaultGatewayList);
}

//set current gateway
enabledGateway(enabledGateway());

//fill list
gatewayListArea.value=getSavedList().join('\n');

//events
testButton.addEventListener('click',e=>{
	saveList(gatewayListArea.value.split('\n'));//save
	// test
	var availableGateways=[];
	testResultArea.innerHTML='';
	for(let g of getSavedList()){
		let R=new ResultBlock(g);
		testResultArea.appendChild(R.block);
		testGateway(g)
		.then(res=>{
			if(res.ok){
				availableGateways.push(g);
				if(availableGateways.length===1 && autoTesting){
					enabledGateway(g);
					viewButton.click();
				}
				R.addText(`	<span class="green">${availableGateways.length}</span>`);
			}else{
				throw(new Error(res.status));
			}
		}).catch(e=>{
			R.addText(`	<span class="red">Error:${e.message}</span>`);
		})
	}
});

var sourceViewFetchController = new AbortController();
function abortFetchRequest(){sourceViewFetchController.abort();sourceViewFetchController=null;}
viewButton.addEventListener('click',e=>{
	if(sourceViewFetchController)sourceViewFetchController.abort();
	try{
		var url=removeEtxSlash(`${enabledGateway()}${toIPFSPath(sourcePathInput.value)}`);
	}catch(e){
		alert(e);
		return;
	}
	setPageArg('path',url);
	sourceViewFetchController = new AbortController();
	sourceContentType.innerText='';
	sourceURL.innerText=sourceURL.href='';
	// sourceURL.setAttribute('download',decodeURIComponent(url.split('/').pop()));
	viewArea.innerHTML='loading...<br>';//clear
	// console.log(url)
	fetch(url,{signal:sourceViewFetchController.signal})
	.then(res=>{
		let type=res.headers.get('content-type');
		sourceContentType.innerText=type;
		sourceURL.innerText=sourceURL.href=decodeURIComponent(url);
		if(type.match(/video|audio/)){
			abortFetchRequest();
			previewMode('video',url);
		}else if(type.match(/image/)){
			previewMode('image',url);
		}else if(type.match(/html|json|xml|pdf/)){
			abortFetchRequest();
			previewMode('iframe',url);
		}else if(type.match(/text/)){
			previewMode('text',null,res);
		}else{
			abortFetchRequest();
			previewMode(null,url);
		}
	}).catch(e=>{
		console.error(e)
		if(e.message.match(/abort/)){return;}
		viewArea.innerHTML=`failed to load<br>${e.message}`;//clear
		sourceContentType.innerText='';
	});
});
disanleAutoTest.addEventListener('change',e=>{
	autoTestDisabled(disanleAutoTest.checked);
});


//auto
var autoTesting=false;
if(('test' in pageArgs) && !autoTestDisabled()){
	autoTesting=true;
	testButton.click();
}
if(pageArgs.path){
	sourcePathInput.value=pageArgs.path;
	autoTesting||viewButton.click();
}
</script>